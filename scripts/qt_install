#!/bin/bash
# ==================================================
# Minty Forge - Qt Environment Setup Script
# Installs and configures Qt5/Qt6 theming on Linux Mint
# ==================================================

set -e

echo "[Minty_Forge] Starting Qt theming installation..."

# --- 1. Prerequisite checks ---
if ! command -v sudo &>/dev/null; then
    echo "❌ sudo command not found. Please run as root."
    exit 1
fi

if ! ping -c 1 archive.ubuntu.com &>/dev/null; then
    echo "⚠️ No Internet connection detected. Please connect and retry."
    exit 1
fi

echo "[1/5] Updating APT repositories..."
sudo apt update -y

# --- 2. Install Qt utilities ---
echo "[2/5] Installing Qt theming tools..."
sudo apt install -y qt5ct qt6ct qt5-style-kvantum kvantum-manager || {
    echo "❌ Failed to install Qt packages."
    exit 1
}

# --- 3. Configure environment variables ---
PROFILE_FILE="$HOME/.profile"

echo "[3/5] Configuring environment variables..."

# Remove previous section if it exists
sed -i '/# --- QT THEME CONFIGURATION (Minty Forge) ---/,/# --- END QT CONFIGURATION ---/d' "$PROFILE_FILE"

cat <<'EOF' >> "$PROFILE_FILE"

# --- QT THEME CONFIGURATION (Minty Forge) ---
# Qt5 applications
export QT_QPA_PLATFORMTHEME=qt5ct
export QT_PLATFORMTHEME=qt5ct
# Qt6 applications
export QT_QPA_PLATFORMTHEME_QT6=qt6ct
export QT_PLATFORMTHEME_QT6=qt6ct
# Kvantum theme engine
export QT_STYLE_OVERRIDE=kvantum
# --- END QT CONFIGURATION ---

EOF

# --- 4. Set Kvantum as default theme in qt5ct and qt6ct ---
echo "[4/5] Setting Kvantum as default theme..."

mkdir -p ~/.config/qt5ct ~/.config/qt6ct

for conf in "$HOME/.config/qt5ct/qt5ct.conf" "$HOME/.config/qt6ct/qt6ct.conf"; do
    if [ ! -f "$conf" ]; then
        touch "$conf"
    fi
    if grep -q "style=" "$conf"; then
        sed -i 's/^style=.*/style=kvantum/' "$conf"
    else
        echo "[Appearance]" >> "$conf"
        echo "style=kvantum" >> "$conf"
    fi
done

# --- 5. Final checks ---
echo "[5/5] Verifying installation..."
for pkg in qt5ct qt6ct kvantum-manager; do
    if command -v $pkg &>/dev/null; then
        echo "✅ $pkg installed"
    else
        echo "⚠️ $pkg not found"
    fi
done

echo ""
echo "✨ Qt theming environment successfully configured!"
echo "You can now launch 'qt5ct', 'qt6ct', or 'kvantum-manager' to adjust styles."
echo "Please log out and back in for changes to take full effect."
