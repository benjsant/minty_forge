#!/bin/bash
# MintyForge - Enhanced APT installation script (non-interactive)
# Purpose: Install all required APT packages, Podman, and Distrobox safely.

set -e  # Exit on first error

# --- Colors ---
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
RED="\033[1;31m"
BLUE="\033[1;34m"
RESET="\033[0m"

info() { echo -e "${BLUE}[INFO]${RESET} $1"; }
success() { echo -e "${GREEN}[OK]${RESET} $1"; }
warn() { echo -e "${YELLOW}[WARN]${RESET} $1"; }
error() { echo -e "${RED}[ERROR]${RESET} $1"; }

echo -e "${GREEN}[MintyForge] Starting APT installation...${RESET}"

# --- Ensure we are in the correct directory ---
CONFIG_FILE="configs/apt.txt"
if [ ! -f "$CONFIG_FILE" ]; then
    error "configs/apt.txt not found. Please run from the project root."
    exit 1
fi

# --- Setup environment for non-interactive install ---
ORIGINAL_FRONTEND="${DEBIAN_FRONTEND}"
export DEBIAN_FRONTEND=noninteractive

# --- Accept Microsoft Fonts EULA automatically ---
echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections

# --- Update repositories ---
info "Updating package lists..."
sudo apt update -y

# --- Install packages from apt.txt ---
info "Installing APT packages from $CONFIG_FILE..."
while IFS= read -r package || [ -n "$package" ]; do
    [[ -z "$package" || "$package" =~ ^# ]] && continue
    if dpkg -l | grep -q "^ii  $package"; then
        warn "$package is already installed, skipping..."
    else
        info "Installing $package..."
        sudo apt install -y "$package" && success "$package installed."
    fi
done < "$CONFIG_FILE"

# --- Podman installation ---
if ! command -v podman &>/dev/null; then
    info "Podman not found. Installing..."
    sudo apt install -y podman && success "Podman installed."
else
    success "Podman already installed, skipping."
fi

# --- Distrobox installation ---
if ! command -v distrobox &>/dev/null; then
    info "Distrobox not found. Installing..."

    # Ensure curl is installed
    if ! command -v curl &>/dev/null; then
        info "Installing curl..."
        sudo apt install -y curl
    fi

    curl -fsSL https://raw.githubusercontent.com/89luca89/distrobox/main/install | sudo sh
    success "Distrobox installed."
else
    success "Distrobox already installed, skipping."
fi

# --- Cleanup ---
export DEBIAN_FRONTEND="${ORIGINAL_FRONTEND}"
success "âœ… All APT packages, Podman, and Distrobox are installed successfully."
