#!/bin/bash
# MintyForge - GTK/Icon/Cursor Themes Installer
# Handles dconf load, user & system themes, slick-greeter, and install.sh for themes

set -e

# -------- Terminal Colors --------
GREEN="\e[32m"
YELLOW="\e[33m"
BLUE="\e[34m"
RED="\e[31m"
RESET="\e[0m"

info() { echo -e "${BLUE}[INFO]${RESET} $1"; }
success() { echo -e "${GREEN}[OK]${RESET} $1"; }
warn() { echo -e "${YELLOW}[WARN]${RESET} $1"; }
error() { echo -e "${RED}[ERROR]${RESET} $1"; }

# -------- Variables --------
USER_NAME=$(logname)
USER_HOME=$(eval echo ~$USER_NAME)

CONFIG_DIR="./configs"
THEMES_DIR="./themes"
ICONS_DIR="./icons"
CURSORS_DIR="./cursors"
DCONF_FILE="$CONFIG_DIR/dconf_base_clean.conf"
SLICK_CONF="/etc/lightdm/slick-greeter.conf"

mkdir -p "$THEMES_DIR" "$ICONS_DIR" "$CURSORS_DIR"

# -------- Load Base dconf --------
if [ -f "$DCONF_FILE" ]; then
    info "Loading base dconf settings..."
    sudo -u "$USER_NAME" dconf load / < "$DCONF_FILE"
    success "Base dconf loaded."
else
    warn "dconf base file not found, skipping..."
fi

# -------- Function to select theme --------
select_theme() {
    local file=$1
    local type=$2
    declare -A THEMES
    i=1
    info "Available $type themes:"
    while IFS="§" read -r name url; do
        echo "$i) $name"
        THEMES[$i]="$name§$url"
        ((i++))
    done < "$file"

    read -p "Choose a $type theme (number): " choice
    THEME_NAME=$(echo "${THEMES[$choice]}" | cut -d'§' -f1)
    THEME_URL=$(echo "${THEMES[$choice]}" | cut -d'§' -f2)

    info "Selected $type theme: $THEME_NAME"

    # Determine target folder
    TARGET_DIR=""
    case $type in
        GTK) TARGET_DIR="$THEMES_DIR/$THEME_NAME" ;;
        Icons) TARGET_DIR="$ICONS_DIR/$THEME_NAME" ;;
        Cursor) TARGET_DIR="$CURSORS_DIR/$THEME_NAME" ;;
    esac

    # Clone if URL is present
    if [ -n "$THEME_URL" ]; then
        if [ ! -d "$TARGET_DIR" ]; then
            info "Cloning $THEME_NAME..."
            git clone "$THEME_URL" "$TARGET_DIR"
            success "$THEME_NAME cloned."
            
            # Run install.sh if it exists
            if [ -f "$TARGET_DIR/install.sh" ]; then
                info "Running install.sh for $THEME_NAME..."
                chmod +x "$TARGET_DIR/install.sh"
                case $type in
                    GTK)
                        "$TARGET_DIR/install.sh" -d "$USER_HOME/.themes" -c dark
                        ;;
                    Icons)
                        "$TARGET_DIR/install.sh" -d "$USER_HOME/.icons"
                        ;;
                    Cursor)
                        "$TARGET_DIR/install.sh" -d "$USER_HOME/.icons"
                        ;;
                esac
                success "$THEME_NAME installed via install.sh."
            fi
        else
            warn "$THEME_NAME already cloned, skipping."
        fi
    else
        info "$THEME_NAME uses system theme, skipping clone."
    fi

    echo "$THEME_NAME"
}

# -------- Selection --------
GTK_THEME=$(select_theme "$CONFIG_DIR/themes_gtk.txt" GTK)
ICON_THEME=$(select_theme "$CONFIG_DIR/themes_icons.txt" Icons)
CURSOR_THEME=$(select_theme "$CONFIG_DIR/themes_cursors.txt" Cursor)

# -------- Copy themes system-wide if cloned --------
[ -d "$THEMES_DIR/$GTK_THEME" ] && sudo cp -r "$THEMES_DIR/$GTK_THEME" /usr/share/themes/
[ -d "$ICONS_DIR/$ICON_THEME" ] && sudo cp -r "$ICONS_DIR/$ICON_THEME" /usr/share/icons/
[ -d "$CURSORS_DIR/$CURSOR_THEME" ] && sudo cp -r "$CURSORS_DIR/$CURSOR_THEME" /usr/share/icons/

# -------- Copy themes for user --------
mkdir -p "$USER_HOME/.themes" "$USER_HOME/.icons"
[ -d "$THEMES_DIR/$GTK_THEME" ] && cp -r "$THEMES_DIR/$GTK_THEME" "$USER_HOME/.themes/"
[ -d "$ICONS_DIR/$ICON_THEME" ] && cp -r "$ICONS_DIR/$ICON_THEME" "$USER_HOME/.icons/"
[ -d "$CURSORS_DIR/$CURSOR_THEME" ] && cp -r "$CURSORS_DIR/$CURSOR_THEME" "$USER_HOME/.icons/"
chown -R $USER_NAME:$USER_NAME "$USER_HOME/.themes" "$USER_HOME/.icons"

# -------- Apply themes via gsettings --------
sudo -u $USER_NAME gsettings set org.cinnamon.desktop.interface gtk-theme "$GTK_THEME"
sudo -u $USER_NAME gsettings set org.cinnamon.desktop.interface icon-theme "$ICON_THEME"
sudo -u $USER_NAME gsettings set org.cinnamon.desktop.interface cursor-theme "$CURSOR_THEME"
sudo -u $USER_NAME gsettings set org.cinnamon.theme name "$GTK_THEME"
success "User session themes applied."

# -------- Apply themes to slick-greeter --------
sudo touch $SLICK_CONF
sudo crudini --set $SLICK_CONF Greeter theme-name "$GTK_THEME"
sudo crudini --set $SLICK_CONF Greeter icon-theme-name "$ICON_THEME"
sudo crudini --set $SLICK_CONF Greeter cursor-theme-name "$CURSOR_THEME"
success "Slick-greeter updated."

echo -e "${GREEN}[MintyForge] ✅ All themes applied successfully!${RESET}"
