#!/usr/bin/env bash
# MintyForge ‚Äì Universal Theme Installer (Cinnamon Edition)
# Linux Mint 22 ‚Äì Robust version with clean output capture and safer operations

set -euo pipefail

# -----------------------------------------------------------------
# Couleurs (si le terminal supporte le texte color√©)
# -----------------------------------------------------------------
if [ -t 1 ]; then
    GREEN="\e[32m"
    YELLOW="\e[33m"
    BLUE="\e[34m"
    RED="\e[31m"
    RESET="\e[0m"
else
    GREEN=""
    YELLOW=""
    BLUE=""
    RED=""
    RESET=""
fi

info()    { echo -e "${BLUE}[INFO]${RESET} $*" >&2; }
success() { echo -e "${GREEN}[OK]${RESET} $*" >&2; }
warn()    { echo -e "${YELLOW}[WARN]${RESET} $*" >&2; }
error()   { echo -e "${RED}[ERROR]${RESET} $*" >&2; }

# -----------------------------------------------------------------
# D√©tection de l'utilisateur actif
# -----------------------------------------------------------------
USER_NAME=$(who | awk '{print $1}' | head -n1)
USER_HOME=$(eval echo "~$USER_NAME")

if [[ -z $USER_NAME ]]; then
    error "Impossible de d√©tecter l'utilisateur."
    exit 1
fi
info "Utilisateur d√©tect√© : $USER_NAME ($USER_HOME)"

# -----------------------------------------------------------------
# Chemins
# -----------------------------------------------------------------
CONFIG_DIR="./configs"
THEMES_DIR="./themes"
ICONS_DIR="./icons"
CURSORS_DIR="./cursors"
DCONF_FILE="$CONFIG_DIR/dconf_base"
SLICK_CONF="/etc/lightdm/slick-greeter.conf"

mkdir -p "$THEMES_DIR" "$ICONS_DIR" "$CURSORS_DIR"

# -----------------------------------------------------------------
# Chargement du dconf de base (si pr√©sent)
# -----------------------------------------------------------------
if [[ -f "$DCONF_FILE" ]]; then
    info "Chargement du fichier dconf de base‚Ä¶"
    sudo -u "$USER_NAME" DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$(id -u "$USER_NAME")/bus" \
        dconf load / < "$DCONF_FILE"
    success "dconf de base charg√©."
else
    warn "Fichier dconf de base introuvable ‚Äì passage."
fi

# -----------------------------------------------------------------
# Fonction d'affichage de la liste des th√®mes
# -----------------------------------------------------------------
# $1 = fichier de configuration (ex. themes_gtk.txt)
# $2 = type affich√© (GTK, Icons, Cursor)
list_themes() {
    local file=$1 type=$2
    local -a names urls
    local i=1

    if [[ ! -f "$file" ]]; then
        error "Fichier de th√®mes $file introuvable."
        exit 1
    fi

    info "Th√®mes $type disponibles :"
    while IFS="|" read -r name url cmd_user cmd_root; do
        [[ -z $name ]] && continue
        printf "  %2d) %s\n" "$i" "$name" >&2
        names[$i]="$name"
        urls[$i]="$url|$cmd_user|$cmd_root"
        ((i++))
    done < "$file"

    local choice
    while true; do
        read -p "Choisissez un th√®me $type (num√©ro) : " choice
        if [[ $choice =~ ^[0-9]+$ ]] && (( choice > 0 && choice < i )); then
            # üîπ Seule cette ligne est envoy√©e sur stdout (capturable)
            echo "${names[$choice]}|${urls[$choice]}"
            return 0
        else
            warn "Num√©ro invalide ‚Äì r√©essayez."
        fi
    done
}

# -----------------------------------------------------------------
# S√©lection des th√®mes (capturent uniquement le choix)
# -----------------------------------------------------------------
GTK_INFO=$(list_themes "$CONFIG_DIR/themes_gtk.txt" "GTK")
ICON_INFO=$(list_themes "$CONFIG_DIR/themes_icons.txt" "Icons")
CURSOR_INFO=$(list_themes "$CONFIG_DIR/themes_cursors.txt" "Cursor")

IFS='|' read -r GTK_THEME GTK_URL GTK_CMD_USER GTK_CMD_ROOT <<< "$GTK_INFO"
IFS='|' read -r ICON_THEME ICON_URL ICON_CMD_USER ICON_CMD_ROOT <<< "$ICON_INFO"
IFS='|' read -r CURSOR_THEME CURSOR_URL CURSOR_CMD_USER CURSOR_CMD_ROOT <<< "$CURSOR_INFO"

info "Th√®me GTK choisi : $GTK_THEME"
info "Th√®me ic√¥nes choisi : $ICON_THEME"
info "Th√®me curseur choisi : $CURSOR_THEME"

# -----------------------------------------------------------------
# Fonction d'installation d'un th√®me (clone + commandes)
# -----------------------------------------------------------------
install_theme() {
    local name=$1 url=$2 cmd_user=$3 cmd_root=$4 target_dir=$5

    if [[ -z "$name" ]]; then
        error "Nom de th√®me vide ‚Äî abandon."
        exit 1
    fi

    # Clone si besoin
    if [[ -n $url && ! -d "$target_dir" ]]; then
        info "Clonage de $name‚Ä¶"
        git clone --depth=1 "$url" "$target_dir" 2>git_err.log || {
            error "√âchec du clone de $name : $(cat git_err.log)"
            exit 1
        }
        success "Clonage termin√©."
    else
        warn "R√©pertoire $target_dir d√©j√† pr√©sent ‚Äì pas de clone."
    fi

    # Propri√©t√© correcte
    sudo chown -R "$USER_NAME":"$USER_NAME" "$target_dir"

    # Commande user
    if [[ -n $cmd_user ]]; then
        info "Ex√©cution de la commande (user) pour $name‚Ä¶"
        (cd "$target_dir" && eval "$cmd_user") 2>user_err.log || {
            error "Erreur user pour $name : $(cat user_err.log)"
            exit 1
        }
        success "Installation user termin√©e."
    fi

    # Commande root
    if [[ -n $cmd_root ]]; then
        info "Ex√©cution de la commande (root) pour $name‚Ä¶"
        (cd "$target_dir" && sudo bash -c "$cmd_root") 2>root_err.log || {
            error "Erreur root pour $name : $(cat root_err.log)"
            exit 1
        }
        success "Installation root termin√©e."
    fi
}

# -----------------------------------------------------------------
# Installation des trois cat√©gories
# -----------------------------------------------------------------
install_theme "$GTK_THEME"   "$GTK_URL"   "$GTK_CMD_USER"   "$GTK_CMD_ROOT"   "$THEMES_DIR/$GTK_THEME"
install_theme "$ICON_THEME"  "$ICON_URL"  "$ICON_CMD_USER"  "$ICON_CMD_ROOT"  "$ICONS_DIR/$ICON_THEME"
install_theme "$CURSOR_THEME" "$CURSOR_URL" "$CURSOR_CMD_USER" "$CURSOR_CMD_ROOT" "$CURSORS_DIR/$CURSOR_THEME"

# -----------------------------------------------------------------
# DBus + gsettings (Cinnamon)
# -----------------------------------------------------------------
USER_DBUS=$(sudo -u "$USER_NAME" dbus-launch --sh-syntax |
            grep -E '^DBUS_SESSION_BUS_ADDRESS' |
            cut -d= -f2-)
export DBUS_SESSION_BUS_ADDRESS=$USER_DBUS
export DISPLAY=:0

apply_gsettings() {
    local schema=$1 key=$2 value=$3
    info "Application de $key ‚Üí $value"
    sudo -u "$USER_NAME" \
        gsettings set "$schema" "$key" "$value" 2>gsettings_err.log || {
        error "gsettings √©chou√© pour $key : $(cat gsettings_err.log)"
        exit 1
    }
    success "$key appliqu√©."
}

apply_gsettings org.cinnamon.desktop.interface gtk-theme   "$GTK_THEME"
apply_gsettings org.cinnamon.desktop.interface icon-theme  "$ICON_THEME"
apply_gsettings org.cinnamon.desktop.interface cursor-theme "$CURSOR_THEME"
apply_gsettings org.cinnamon.desktop.wm.preferences theme "$GTK_THEME"

# -----------------------------------------------------------------
# V√©rification des valeurs appliqu√©es
# -----------------------------------------------------------------
verify_theme() {
    local schema=$1 key=$2 expected=$3
    local current
    current=$(sudo -u "$USER_NAME" \
        gsettings get "$schema" "$key" 2>/dev/null | tr -d "'")
    if [[ $current == "$expected" ]]; then
        success "V√©rif : $key = $expected"
    else
        warn "V√©rif : $key attendu $expected, obtenu $current"
    fi
}

verify_theme org.cinnamon.desktop.interface gtk-theme   "$GTK_THEME"
verify_theme org.cinnamon.desktop.interface icon-theme  "$ICON_THEME"
verify_theme org.cinnamon.desktop.interface cursor-theme "$CURSOR_THEME"
verify_theme org.cinnamon.desktop.wm.preferences theme   "$GTK_THEME"

# -----------------------------------------------------------------
# Mise √† jour du greeter LightDM
# -----------------------------------------------------------------
if ! command -v crudini >/dev/null; then
    warn "crudini absent ‚Äì installation automatique."
    sudo apt-get update && sudo apt-get install -y crudini
fi

success "Installation compl√®te termin√©e üéâ"
