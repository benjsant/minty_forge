#!/usr/bin/env bash
# MintyForge ‚Äì Main Script (Cinnamon Edition)
# Utility for Linux Mint Cinnamon configuration and setup
# Version 2.0 ‚Äì with logging, colors, and robust error handling

set -euo pipefail

# -----------------------------------------------------------------
# Setup & Paths
# -----------------------------------------------------------------
LOGDIR="logs"
LOGFILE="$LOGDIR/mintyforge.log"
mkdir -p "$LOGDIR"

# -----------------------------------------------------------------
# Colors (if terminal supports them)
# -----------------------------------------------------------------
if [ -t 1 ]; then
    GREEN="\e[32m"
    YELLOW="\e[33m"
    BLUE="\e[34m"
    RED="\e[31m"
    RESET="\e[0m"
else
    GREEN=""
    YELLOW=""
    BLUE=""
    RED=""
    RESET=""
fi

info()    { echo -e "${BLUE}[INFO]${RESET} $*" | tee -a "$LOGFILE"; }
success() { echo -e "${GREEN}[OK]${RESET} $*" | tee -a "$LOGFILE"; }
warn()    { echo -e "${YELLOW}[WARN]${RESET} $*" | tee -a "$LOGFILE"; }
error()   { echo -e "${RED}[ERROR]${RESET} $*" | tee -a "$LOGFILE"; }

# -----------------------------------------------------------------
# Check Internet connection
# -----------------------------------------------------------------
info "Checking Internet connection..."
if ! ping -c 1 -W 2 archive.ubuntu.com &>/dev/null; then
    error "No Internet connection detected. Please connect and retry."
    exit 1
fi
success "Internet connection detected."

# -----------------------------------------------------------------
# Disable suspend & screensaver temporarily
# -----------------------------------------------------------------
info "Disabling suspend and screensaver temporarily..."
gsettings set org.cinnamon.settings-daemon.plugins.power sleep-inactive-ac-timeout 0
gsettings set org.cinnamon.settings-daemon.plugins.power sleep-inactive-battery-timeout 0
gsettings set org.cinnamon.desktop.screensaver lock-enabled false
success "Suspend and screensaver disabled."

# -----------------------------------------------------------------
# Update system
# -----------------------------------------------------------------
info "Updating system packages..."
sudo apt update -y | tee -a "$LOGFILE"
sudo apt upgrade -y | tee -a "$LOGFILE"
success "System updated."

# -----------------------------------------------------------------
# Main Menu
# -----------------------------------------------------------------
main_menu() {
    clear
    echo "=================================="
    echo "        üõ†Ô∏è MintyForge Menu"
    echo "=================================="
    echo "1) Install APT packages"
    echo "2) Remove unwanted APT packages"
    echo "3) Install Flatpaks"
    echo "4) Install User Themes (GTK, Icons, Cursors)"
    echo "5) Configure Drivers"
    echo "6) Configure Qt Apps"
    echo "7) Run Distroscript"
    echo "0) Exit"
    echo "=================================="
    echo

    read -rp "Choose an option: " choice
    echo "" | tee -a "$LOGFILE"

    case $choice in
        1)
            info "Launching APT package installation..."
            ./scripts/apt_install | tee -a "$LOGFILE"
            ;;
        2)
            info "Launching APT package removal..."
            ./scripts/apt_remove | tee -a "$LOGFILE"
            ;;
        3)
            info "Launching Flatpak installation..."
            ./scripts/flatpak_install | tee -a "$LOGFILE"
            ;;
        4)
            info "Launching Theme Installer..."
            ./scripts/themes_install | tee -a "$LOGFILE"
            ;;
        5)
            info "Launching Driver configuration..."
            ./scripts/drivers | tee -a "$LOGFILE"
            ;;
        6)
            info "Launching Qt app configuration..."
            ./scripts/qt_install | tee -a "$LOGFILE"
            ;;
        7)
            info "Running DistroScript..."
            ./scripts/distroscript | tee -a "$LOGFILE"
            ;;
        0)
            success "Exiting MintyForge. Goodbye!"
            exit 0
            ;;
        *)
            warn "Invalid option. Please try again."
            ;;
    esac
}

# -----------------------------------------------------------------
# Main loop
# -----------------------------------------------------------------
while true; do
    main_menu
    echo
    read -rp "Press Enter to continue..."
done
